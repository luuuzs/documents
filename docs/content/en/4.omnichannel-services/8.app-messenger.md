---
title: Messenger
description: Integração completa da plataforma Facebook Messenger
navigation:
  icon: i-lucide-message-square
---

# App Messenger

## Visão Geral

O **App Messenger** é uma aplicação Node.js robusta e completa para integração com o Facebook Messenger, projetada para ambientes empresariais de alto volume. A aplicação funciona como um webhook handler que processa mensagens bidirecionais entre usuários do Facebook Messenger e um sistema central de chat omnichannel.

### Características Principais

- **Webhook Handler Dinâmico**: Processa eventos do Facebook Messenger em tempo real com URLs únicas por aplicação
- **Multi-App Support**: Gerencia múltiplas páginas/aplicações do Messenger simultaneamente com configurações independentes
- **Processamento de Mídia Completo**: Suporte para texto, imagens, vídeos, áudio, arquivos PDF e templates interativos
- **Segurança Empresarial**: SSL/TLS obrigatório, autenticação via token estático (x-auth-token) e validação rigorosa de tokens
- **Integração MongoDB**: Armazenamento persistente de configurações
- **Sistema de Monitoramento**: Endpoints para status, reinicialização e health checks

## Arquitetura Técnica

### Estrutura de Arquivos

\`\`\`
/opt/app.messenger/
├── app.js                 # Aplicação principal (658 linhas)
├── package.json           # Configuração do projeto
└── package-lock.json      # Lock de dependências
\`\`\`

### Stack Tecnológico

#### Dependências Core (package.json)

\`\`\`json
{
"name": "Messenger",
"version": "1.0.0",
"description": "Chat of Messenger API",
"author": "Luiz Paulo",
"dependencies": {
"express": "^4.17.3",
"mongodb": "^3.6.0",
"jsonwebtoken": "^8.5.1",
"request": "^2.88.2",        // ⚠️ DEPRECATED: request é legado no ecossistema Node.js
"cors": "^2.8.5",
"body-parser": "^1.19.2",
"dotenv": "^16.3.1"
}
}
\`\`\`

::alert{type="warning"}
**Nota Técnica**: A biblioteca `request` está deprecated desde 2020. O código atual ainda funciona, mas para futuras atualizações considere migrar para `axios`, `node-fetch` ou `fetch` nativo (Node.js 18+).
::

### Diagrama de Fluxo Simplificado

\`\`\`
┌─────────────┐    ┌──────────────────┐    ┌─────────────┐    ┌─────────────┐
│  Messenger  │───▶│ webhook{HASH}    │───▶│    Core     │───▶│ Graph API   │
│   (User)    │    │ :1332/api/v1/    │    │ :3034/      │    │ Facebook    │
└─────────────┘    └──────────────────┘    └─────────────┘    └─────────────┘
│                       ▲
▼                       │
┌──────────────────┐    ┌─────────────┐
│    MongoDB       │    │ Sistema     │
│   (configs)      │    │ Central     │
└──────────────────┘    └─────────────┘
\`\`\`

## Configuração e Instalação

### Variáveis de Ambiente Obrigatórias

\`\`\`bash
# MongoDB
MONGODB_URI=mongodb://localhost:27017/

# Configurações obtidas do banco de dados 'mytuite_apps':
# - AuthToken (token estático para autenticação interna)
# - External_Url (URL pública do servidor)
# - filePath (caminho para uploads de arquivos)
\`\`\`

### Certificados SSL (Obrigatórios)

\`\`\`bash
# Localização dos certificados
/etc/nginx/myuc2b.com.key    # Chave privada
/etc/nginx/myuc2b.com.crt    # Certificado público
\`\`\`

### Configuração de Rede

- **Porta HTTPS**: 1332 (hardcoded)
- **Protocolo**: HTTPS obrigatório
- **CORS**: Habilitado para todas as origens

### Inicialização

\`\`\`bash
cd /opt/app.messenger
node app.js  # Executa: node app.js
\`\`\`

## Funcionalidades Detalhadas

### 1. Sistema de Webhooks Dinâmicos

#### Geração de URLs Únicas

Cada aplicação Messenger recebe uma URL única baseada no HASH:

\`\`\`javascript
// Exemplo de URL gerada dinamicamente
POST /api/v1/webhookABC123XYZ  // Para app com HASH="ABC123XYZ"
GET  /api/v1/webhookABC123XYZ  // Para verificação do Facebook
\`\`\`

#### Processamento de Eventos

**Estrutura de Evento Recebido:**
\`\`\`javascript
{
"object": "page",
"entry": [{
"messaging": [{
"sender": {"id": "USER_PSID"},
"recipient": {"id": "PAGE_ID"},
"timestamp": 1234567890,
"message": {
"text": "Mensagem do usuário"
}
}]
}]
}
\`\`\`

### 2. Processamento de Mensagens (handleMessageReceipt)

#### Mensagens de Texto
\`\`\`javascript
// Input do Facebook
{
"text": "Olá, preciso de ajuda"
}

// Output para sistema central
{
"_id": "ObjectId_da_sala",
"name": "USER_PSID",
"fname": "USER_PSID",
"profile_name": "João Silva",
"channel": "Messenger",
"broker": "Messenger",
"appName": "PAGE_ID",
"psid": "USER_PSID",
"type": "text",
"text": "Olá, preciso de ajuda"
}
\`\`\`

#### Anexos de Mídia
\`\`\`javascript
// Input do Facebook
{
"attachments": [{
"type": "image",
"payload": {
"url": "https://scontent.xx.fbcdn.net/v/image.jpg"
}
}]
}

// Output processado
{
"_id": "ObjectId_da_sala",
"type": "image", // Pode ser MIME-like: application/pdf, video/mp4, audio/ogg
"title": "image.jpg",
"url": "https://scontent.xx.fbcdn.net/v/image.jpg"
// ... outros campos padrão
}
\`\`\`

#### Postbacks (Botões)
\`\`\`javascript
// Input do Facebook
{
"postback": {
"payload": "GET_STARTED_PAYLOAD"
}
}

// Output processado
{
"type": "text",
"text": "GET_STARTED_PAYLOAD"
// ... outros campos padrão
}
\`\`\`

### 3. Envio de Mensagens (handleMessageSend)

#### Texto Simples
\`\`\`javascript
// Input da API interna
{
"appName": "PAGE_ID",
"psid": "USER_PSID",
"type": "text",
"text": "Obrigado pelo contato!"
}

// Output para Graph API
{
"recipient": {"id": "USER_PSID"},
"message": {
"text": "Obrigado pelo contato!"
}
}
\`\`\`

#### Botões Interativos
\`\`\`javascript
// Input da API interna
{
"type": "button",
"text": [{
"text": "Escolha uma opção:",
"actions": [
{"text": "Suporte", "msg": "SUPORTE"},
{"text": "Vendas", "msg": "VENDAS"}
]
}]
}

// Output para Graph API
{
"attachment": {
"type": "template",
"payload": {
"template_type": "button",
"text": "Escolha uma opção:",
"buttons": [
{"type": "postback", "title": "Suporte", "payload": "SUPORTE"},
{"type": "postback", "title": "Vendas", "payload": "VENDAS"}
]
}
}
}
\`\`\`

#### Templates de Mídia
\`\`\`javascript
// Imagem com template genérico
{
"attachment": {
"type": "template",
"payload": {
"template_type": "generic",
"elements": [{
"title": "produto.jpg",
"subtitle": "",
"image_url": "https://servidor.com/uploads/produto.jpg"
}]
}
}
}

// Arquivo direto
{
"attachment": {
"type": "file",
"payload": {
"title": "documento.pdf",
"url": "https://servidor.com/uploads/documento.pdf",
"is_reusable": true
}
}
}
\`\`\`

### 4. Gerenciamento de Perfis (profileData)

#### Busca de Dados do Usuário
\`\`\`javascript
// Requisição para Graph API
GET https://graph.facebook.com/{USER_PSID}?access_token={TOKEN}&fields=first_name,last_name,profile_pic

// Resposta processada
{
"fname": "João Silva",
"pic": "https://platform-lookaside.fbsbx.com/platform/profilepic/"
}
\`\`\`

#### Download de Fotos de Perfil (downloadPic)
\`\`\`javascript
// Estrutura de armazenamento
/uploads/
/localPicFilePath/
/{roomId}.jpg  // Foto do perfil do usuário
\`\`\`

### 5. Detecção de Tipos de Arquivo (contentType)

\`\`\`javascript
// Mapeamento de extensões
const typeMapping = {
'.png': 'image',
'.jpg': 'image',
'.svg': 'image',
'.pdf': 'application/pdf',  // Tipo MIME-like
'.mp4': 'video/mp4',        // Tipo MIME-like
'.mpeg': 'video/mpeg',      // Tipo MIME-like
'.ogg': 'audio/ogg',        // Tipo MIME-like
'.wav': 'audio/x-wav',      // Tipo MIME-like
'.mp3': 'audio/mp3'         // Tipo MIME-like
// default: 'file'
}

// Nota: O type retornado pode ser MIME-like (ex.: application/pdf, video/mp4, audio/ogg)
// não apenas os tipos básicos image|file|video|audio
\`\`\`

## API Endpoints Completos

### Webhooks do Facebook (Dinâmicos)

#### POST `/api/v1/webhook{HASH}`
\`\`\`javascript
// Headers obrigatórios
Content-Type: application/json

// Payload de exemplo
{
"object": "page",
"entry": [/* eventos do messenger */]
}

// Resposta
HTTP 200 "EVENT_RECEIVED"
\`\`\`

#### GET `/api/v1/webhook{HASH}`
\`\`\`javascript
// Query parameters (verificação do Facebook)
?hub.mode=subscribe
&hub.verify_token=VERIFY_TOKEN
&hub.challenge=CHALLENGE_STRING

// Resposta (se token válido)
HTTP 200 CHALLENGE_STRING

// Resposta (se token inválido)  
HTTP 403 Forbidden
\`\`\`

### API Interna (Token Estático Protected)

#### POST `/chat.postMessage`

**Exemplo cURL Completo**:
\`\`\`bash
curl -X POST https://servidor.com:1332/chat.postMessage \
-H "Content-Type: application/json" \
-H "x-auth-token: seu_token_estatico_aqui" \
-d '{
"appName": "123456789",
"psid": "1234567890123456",
"type": "text",
"text": "Olá! Como posso ajudá-lo hoje?"
}'
\`\`\`

**Respostas Possíveis**:
\`\`\`javascript
// ✅ Sucesso
HTTP 200 OK
"EVENT_SEND"

// ❌ Token inválido/ausente
HTTP 401 Unauthorized
{
"auth": false,
"message": "No token provided."
}

// ❌ Token incorreto
HTTP 500 Internal Server Error
{
"auth": false,
"message": "Failed to authenticate token."
}

// ❌ Parâmetros inválidos
HTTP 400 Bad Request
{
"error": "Missing required parameters"
}
\`\`\`

**Exemplo com Botões**:
\`\`\`bash
curl -X POST https://servidor.com:1332/chat.postMessage \
-H "Content-Type: application/json" \
-H "x-auth-token: seu_token_estatico_aqui" \
-d '{
"appName": "123456789",
"psid": "1234567890123456",
"type": "button",
"text": [{
"text": "Escolha uma opção:",
"actions": [
{"text": "Suporte Técnico", "msg": "SUPORTE_TECNICO"},
{"text": "Vendas", "msg": "VENDAS"},
{"text": "Financeiro", "msg": "FINANCEIRO"}
]
}]
}'
\`\`\`

#### GET `/system/status`

**Exemplo cURL**:
\`\`\`bash
curl -H "x-auth-token: seu_token_estatico_aqui" \
https://servidor.com:1332/system/status
\`\`\`

**Respostas de Status**:
\`\`\`javascript
// ✅ Sistema funcionando com apps configuradas
{
"running": true,
"enabled": true,  // true = pelo menos uma app tem PAGE_ACCESS_TOKEN válido
"apps": [
{
"CHANNEL": "Messenger",
"NAME": "Minha Empresa - Suporte",
"PAGE": "Suporte Técnico",
"PAGE_ID": "123456789",
"PAGE_ACCESS_TOKEN": "EAABwzLix...", // Truncado para segurança
"VERSION": "v2.6",
"VERIFY_TOKEN": "verify_token_123",
"HASH": "ABC123XYZ",
"CALLBACK_URL": "https://servidor.com:1332/api/v1/webhookABC123XYZ"
}
]
}

// ⚠️ Sistema rodando mas sem apps configuradas
{
"running": true,
"enabled": false,  // false = nenhuma app tem PAGE_ACCESS_TOKEN
"apps": []
}

// ❌ Erro de autenticação
HTTP 401/500 (conforme verifyJWT)
\`\`\`

#### GET `/system/reboot`

**Exemplo cURL**:
\`\`\`bash
curl -H "x-auth-token: seu_token_estatico_aqui" \
https://servidor.com:1332/system/reboot
\`\`\`

**Comportamento**:
\`\`\`javascript
// ✅ Sucesso
{
"success": true
}

// Log impresso no console:
// "/telegram/system/reboot"

// Ação: process.exit(0) após 1000ms
// Sistema reinicia automaticamente (via PM2/systemd)
\`\`\`

## Funcionalidades Detalhadas (Functions Reference)

### Core Functions (Funções Principais)

#### 1. `handleMessageReceipt(senderPsid, receivedMessage, appName)`
**Propósito**: Processa mensagens recebidas do Facebook Messenger
**Parâmetros**:
- `senderPsid` (string): Page-Scoped ID do usuário
- `receivedMessage` (object): Objeto da mensagem do Facebook
- `appName` (string): ID da página do Facebook

**Fluxo de Execução**:
\`\`\`javascript
1. Buscar/criar sala no sistema → findOneRoomByAppNameAndBrokerReturnTheID()
2. Buscar dados do perfil → profileData()
3. Download foto de perfil → downloadPic()
4. Processar conteúdo da mensagem (texto/anexo/postback)
5. Enviar para sistema central → POST localhost:3034/webhook
   \`\`\`

#### 2. `handleMessageSend(appName, psid, type, text)`
**Propósito**: Envia mensagens para usuários via Graph API
**Parâmetros**:
- `appName` (string): PAGE_ID da aplicação
- `psid` (string): Page-Scoped ID do destinatário
- `type` (string): Tipo da mensagem (text|button|image|file|video|audio)
- `text` (mixed): Conteúdo da mensagem

**Tipos Suportados**:
\`\`\`javascript
// text: string simples
// button: array com {text, actions}
// image/file/video/audio: {title, url}
\`\`\`

#### 3. `profileData(psid, appName)`
**Propósito**: Busca dados do perfil do usuário via Graph API
**Retorno**:
\`\`\`javascript
{
"fname": "João Silva",           // first_name + last_name
"pic": "https://platform-lookaside.fbsbx.com/..."
}
\`\`\`

#### 4. `downloadPic(url, roomId)`
**Propósito**: Download e armazenamento local da foto de perfil
**Localização**: `{filePath}/localPicFilePath/{roomId}.jpg`

#### 5. `contentType(url)`
**Propósito**: Detecta tipo de arquivo baseado na extensão
**Retorno**: MIME-like types (application/pdf, video/mp4, audio/ogg) ou tipos básicos

#### 6. `verifyJWT(req, res, next)` ⚠️ **Nome Enganoso**
**Propósito**: Middleware de autenticação via token estático (NÃO é JWT real)
**Funcionamento**: Compara `req.headers['x-auth-token']` com `AuthToken` do MongoDB

#### 7. `logsMessages(message, data, isJson)`
**Propósito**: Sistema de logs personalizado com formatação
**Uso**: Debug e monitoramento de eventos

#### 8. `asyncForEach(array, callback)`
**Propósito**: Processamento assíncrono de arrays
**Uso**: Iterar sobre múltiplas mensagens/eventos

## Banco de Dados MongoDB

### Database: `mytuite`

#### Collection: `mytuite_apps`

**Documento de Configuração Geral:**
\`\`\`javascript
{
"_id": ObjectId,
"appName": "Configs",
"configs": {
"AuthToken": "token_estatico_interno",
"External_Url": "https://servidor.com",
"filePath": "/caminho/para/uploads"
}
}
\`\`\`

**Documento de Configuração Messenger:**
\`\`\`javascript
{
"_id": ObjectId,
"appName": "Messenger",
"configs": {
"nome_da_pagina_1": {
"PAGE_ID": "123456789",
"PAGE_ACCESS_TOKEN": "EAABwzLixnjYBAO...",
"VERIFY_TOKEN": "meu_verify_token_123",
"HASH": "ABC123XYZ",
"VERSION": "v2.6",
"NAME": "Minha Página",
"PAGE": "Nome Amigável"
},
"nome_da_pagina_2": {
// ... configuração de outra página
}
}
}
\`\`\`

### Integração com app.accounts

\`\`\`javascript
// Funções importadas
const {
findRoomOneByIdOrNameReturnTheID,
findOneRoomByAppNameAndBrokerReturnTheID
} = require('../app.accounts/app/models/room.js');

// Uso para buscar/criar salas
let roomId = await findOneRoomByAppNameAndBrokerReturnTheID(appName, psid);
if (!roomId || roomId.length === 0) {
roomId = ObjectId(); // Nova sala
}
\`\`\`

## Segurança e Autenticação

### Autenticação via Token Estático (verifyJWT)

\`\`\`javascript
// Middleware de verificação (nome mantido por compatibilidade)
// IMPORTANTE: Não usa JWT real, apenas compara token estático
function verifyJWT(req, res, next) {
const token = req.headers['x-auth-token'];

if (!token) {
return res.status(401).json({
auth: false,
message: 'No token provided.'
});
}

// Comparação direta com AuthToken do MongoDB (não jwt.verify)
if (token === AuthToken) {
next();
} else {
res.status(500).json({
auth: false,
message: 'Failed to authenticate token.'
});
}
}
\`\`\`

### Validação de Webhooks do Facebook

\`\`\`javascript
// Verificação de token
if (mode === 'subscribe' && token === VERIFY_TOKEN) {
res.status(200).send(challenge);
} else {
res.sendStatus(403);
}

// Validação de objeto
if (requestBody.object === 'page') {
// Processar eventos
} else {
res.status(200).send('EVENT_RECEIVED');
}
\`\`\`

### Certificados SSL

- **Localização Fixa**: `/etc/nginx/myuc2b.com.*`
- **Protocolo**: HTTPS obrigatório na porta 1332
- **Validação**: Facebook requer HTTPS para webhooks

## Sistema de Logs (logsMessages)

### Função de Log Personalizada

\`\`\`javascript
function logsMessages(message, data, isJson) {
console.log("***********************************************************");
if (isJson) {
console.log(message + " Json: " + JSON.stringify(data));
} else {
console.log(message + " Text: " + data);
}
console.log("***********************************************************");
}
\`\`\`

### Pontos de Log Principais

- **Webhook Events**: Todos os eventos recebidos do Facebook
- **Message Processing**: Processamento de cada mensagem
- **Profile Data**: Dados de perfil obtidos
- **API Responses**: Respostas da Graph API
- **Configuration Loading**: Carregamento de configurações
- **Error Handling**: Erros e exceções

## Monitoramento e Troubleshooting

### Health Checks

\`\`\`bash
# Verificar status da aplicação
curl -H "x-auth-token: SEU_TOKEN_ESTATICO" \
https://servidor.com:1332/system/status

# Resposta esperada
{
"running": true,
"enabled": true,
"apps": [...]
}
\`\`\`

### Comandos de Manutenção

\`\`\`bash
# Reiniciar aplicação
curl -H "x-auth-token: SEU_TOKEN_ESTATICO" \
https://servidor.com:1332/system/reboot

# Testar webhook (deve retornar 403 sem parâmetros)
curl -X POST https://servidor.com:1332/api/v1/webhookHASH

# Testar verificação do Facebook
curl "https://servidor.com:1332/api/v1/webhookHASH?hub.mode=subscribe&hub.verify_token=SEU_VERIFY_TOKEN&hub.challenge=test"
\`\`\`

### Problemas Comuns e Soluções

#### 1. Webhook não recebe mensagens
\`\`\`bash
# Verificar configuração no Facebook Developers
# URL: https://developers.facebook.com/apps/SEU_APP_ID/webhooks/

# Verificar se URL está acessível
curl -I https://servidor.com:1332/api/v1/webhookHASH

# Verificar logs da aplicação
tail -f /var/log/messenger.log
\`\`\`

#### 2. Erro de autenticação Token Estático
\`\`\`javascript
// Verificar se token está correto no banco
db.mytuite_apps.findOne({appName: "Configs"})

// Verificar header da requisição
x-auth-token: TOKEN_CORRETO
\`\`\`

#### 3. Certificados SSL expirados
\`\`\`bash
# Verificar validade dos certificados
openssl x509 -in /etc/nginx/myuc2b.com.crt -text -noout

# Renovar certificados e reiniciar aplicação
\`\`\`

#### 4. MongoDB desconectado
\`\`\`javascript
// Verificar conexão
mongo mongodb://localhost:27017/mytuite

// Verificar logs de conexão
grep "MongoDB" /var/log/messenger.log
\`\`\`

#### 1. Status `enabled: false` mesmo com configurações

**Diagnóstico**:
\`\`\`bash
# Verificar se PAGE_ACCESS_TOKEN existe e não está vazio
curl -H "x-auth-token: SEU_TOKEN" https://servidor.com:1332/system/status | jq '.apps[].PAGE_ACCESS_TOKEN'

# Testar token diretamente na Graph API
curl "https://graph.facebook.com/me?access_token=SEU_PAGE_ACCESS_TOKEN"
\`\`\`

**Solução**:
\`\`\`javascript
// Verificar no MongoDB se o token está correto
db.mytuite_apps.findOne({appName: "Messenger"})

// O campo PAGE_ACCESS_TOKEN não pode estar vazio ou undefined
\`\`\`

#### 2. Webhook retorna 403 na verificação

**Diagnóstico**:
\`\`\`bash
# Testar verificação manual
curl "https://servidor.com:1332/api/v1/webhookHASH?hub.mode=subscribe&hub.verify_token=SEU_VERIFY_TOKEN&hub.challenge=test123"

# Deve retornar: test123
# Se retornar 403: VERIFY_TOKEN incorreto
\`\`\`

#### 3. Mensagens não chegam no sistema central

**Diagnóstico**:
\`\`\`bash
# Verificar se Core está rodando
curl -I http://localhost:3034/webhook

# Verificar logs do Messenger
tail -f /var/log/messenger.log | grep "localhost:3034"
\`\`\`

#### 4. Erro "Failed to authenticate token"

**Diagnóstico**:
\`\`\`javascript
// Verificar se AuthToken no MongoDB está correto
db.mytuite_apps.findOne({appName: "Configs"}).configs.AuthToken

// Comparar com header enviado
x-auth-token: DEVE_SER_EXATAMENTE_IGUAL
\`\`\`

## Performance e Escalabilidade

### Otimizações Implementadas

- **Cache de Configurações**: Configurações carregadas na inicialização
- **Processamento Assíncrono**: `asyncForEach` para arrays

### Limitações Atuais

- **Single Process**: Aplicação roda em processo único
- **Rate Limiting**: Limitado pela Graph API do Facebook (varia conforme políticas do Facebook)
- **Storage Local**: Arquivos armazenados no filesystem local
- **Memory Usage**: Configurações mantidas em memória

### Recomendações para Produção

\`\`\`javascript
// Configurações recomendadas para produção
const productionConfig = {
// Process management
"pm2": "ecosystem.config.js",

// Monitoring
"healthCheck": "/system/status",
"logRotation": "daily",

// Security
"rateLimiting": "100 req/min per IP",
"firewall": "porta 1332 apenas para Facebook IPs",

// Backup
"mongoBackup": "daily",
"configBackup": "before changes"
}
\`\`\`

## Configuração do Facebook Developers

### 1. Criar Aplicação

\`\`\`javascript
// Passos no Facebook Developers Console
1. Acesse https://developers.facebook.com/apps/
2. Criar Nova Aplicação → Tipo: Business
3. Adicionar Produto: Messenger
4. Configurar Webhook:
    - URL: https://servidor.com:1332/api/v1/webhookHASH
    - Verify Token: SEU_VERIFY_TOKEN
    - Subscription Fields: messages, messaging_postbacks
      \`\`\`

### 2. Configurar Permissões

\`\`\`javascript
// Permissões necessárias
const requiredPermissions = [
"pages_messaging",           // Enviar/receber mensagens
"pages_show_list",          // Listar páginas
"pages_manage_metadata"     // Gerenciar metadados
];
\`\`\`

### 3. Gerar Tokens

\`\`\`javascript
// Page Access Token
// Gerado em: Messenger → Settings → Access Tokens
// Formato: EAABwzLixnjYBAO...

// Verify Token  
// Definido por você, usado na verificação do webhook
// Exemplo: "meu_verify_token_123"
\`\`\`

## Fluxo de Dados Completo

### 1. Inicialização da Aplicação

\`\`\`
1. Carregar certificados SSL (/etc/nginx/myuc2b.com.*)
2. Conectar MongoDB (mytuite database)
3. Buscar configurações gerais (AuthToken, External_Url, filePath)
4. Buscar configurações Messenger (PAGE_ACCESS_TOKEN, VERIFY_TOKEN, etc.)
5. Criar rotas dinâmicas para cada aplicação (/api/v1/webhook{HASH})
6. Iniciar servidor HTTPS na porta 1332
   \`\`\`

### 2. Processamento de Mensagem Recebida

\`\`\`
Facebook → Webhook → Validação → Busca/Criação Sala → Busca Perfil →
Download Foto (se necessário) → Processamento Mensagem → Envio para Core
\`\`\`

### 3. Envio de Mensagem

\`\`\`
Sistema Central → API Interna (/chat.postMessage) → Validação Token Estático →
Formatação Mensagem → Graph API → Facebook Messenger → Usuário
\`\`\`

### 4. Gerenciamento de Usuário Novo

\`\`\`
Primeira Mensagem → Verificar Sala Existente → Criar Nova Sala →
Buscar Perfil Facebook → Download Foto Perfil → Armazenar Localmente →
Processar Mensagem
\`\`\`

Esta documentação técnica completa fornece todos os detalhes necessários para implementação, manutenção e troubleshooting do App Messenger em ambiente de produção.
